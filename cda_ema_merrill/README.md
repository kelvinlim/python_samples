# cda_ema_merrill

Does the cda analysis on the ema data from Merrill

Carpenter RW, Merrill JE.  How much and how fast: Alcohol consumption patterns, drinking-episode affect, and next-day consequences in the daily life of underage heavy drinkers.
Drug Alcohol Depend. 2021 Jan 1;218:108407. doi: 10.1016/j.drugalcdep.2020.108407. Epub 2020 Nov 14.
PMID: 33257198

## Data directory organization
dataraw - holds original data from the site.

dataorig - holds the individual subject files extracted from the single csv file
dataraw/1b_COVID19_daily_survey_ALL_cleaned_deid.csv

data - holds standardized data

output - contains processed files

pdfs, pngs - contains the plots if any are generated

## Programs to run for processing

### 1. extractdata.py
Reads in the original csv file and extracts each subjects data and then
creates a dataframe. New csv files are placed in dataorig

### 2. renamedata.py
Reads in the original csv files and renames the columns that have an illegal character for R.
Substitutes a '.' for a '-'.  Also can remove columns to reduce
the amount of data.  Also standardizes the data so each column is zero mean
with a stdev of 1.0.

Reads from the dataorig directory.
New files are written to the data directory.
```
usage: renamedata.py [-h] [--start START] [--end END] [--drop DROP] [--nostd]
                     [--list]

rename columns in csv files making them R compatible, also standardizes the
data to mean of 0 and stdev of 1

optional arguments:
  -h, --help     show this help message and exit
  --start START  beginning file list index , default 0
  --end END      end file list index, default None
  --drop DROP    columns to drop, 'R_' would drop columns beginning with those
                 characters, default is no columns are dropped
  --nostd        do not standardize the columns
  --list         TODO - list the files to be processeddropped
```

### 3. causalwrap.py
Runs the causal-cmd with fges.  Writes a lav model file and txt 
result file into the
output directory for each csv data file in data directory.

```
usage: causalwrap.py [-h] [--start START] [--end END] [--list]

runs causal-cmd with fges

optional arguments:
  -h, --help     show this help message and exit
  --start START  beginning file list index , default 0
  --end END      end file list index, default None
  --list         TODO - list the files to be processed
```

### 4. sem_multi.py
Runs the sem on the lavaan model produced by causalwrap.py. 
This provides the estimates and direction for the determined
edges.  Uses the lavaan files for the model.

```
usage: sem_multi.py [-h] [--start START] [--end END] [--list] [--noplot]

Does the sem estimates for the lavaan model. The semopy package is used.

optional arguments:
  -h, --help     show this help message and exit
  --start START  beginning file list index , default 0
  --end END      end file list index, default None
  --list         TODO list the files to be processed
  --noplot       do not create the plot files, default is to create the plot
                 files
```
### Sample processing sequence
```
# extract data
./extractdata_lag.py

# rename and resample data, dropping the columns beginning with 'R_'
./renamedata.py 

# run causal_cmd with fges algorithm
./causalwrap.py 

# run the sem
./sem_multi.py 

## Error with sem_calc_simple.R

Uses lavaan to compute the SEM for the model generated by causal-cmd.  I get the 
following error:

```
> fit1 <- lavaan(mymodel, data = df,
+     auto.var = TRUE
+     )
Warning message:
In lav_model_vcov(lavmodel = lavmodel, lavsamplestats = lavsamplestats,  :
  lavaan WARNING:
    Could not compute standard errors! The information matrix could
    not be inverted. This may be a symptom that the model is not
    identified.
> 
```
